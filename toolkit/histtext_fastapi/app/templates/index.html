<!-- Updated template with modern color system -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HistText Toolkit Web UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        /* Modern color system aligned with React/TSX applications */
        :root {
            /* Primary Brand Colors */
            --primary-50: #f0f9ff;
            --primary-100: #e0f2fe;
            --primary-200: #bae6fd;
            --primary-300: #7dd3fc;
            --primary-400: #38bdf8;
            --primary-500: #0ea5e9;
            --primary-600: #0284c7;
            --primary-700: #0369a1;
            --primary-800: #075985;
            --primary-900: #0c4a6e;
            
            /* Secondary/Accent Colors */
            --secondary-50: #f8fafc;
            --secondary-100: #f1f5f9;
            --secondary-200: #e2e8f0;
            --secondary-300: #cbd5e1;
            --secondary-400: #94a3b8;
            --secondary-500: #64748b;
            --secondary-600: #475569;
            --secondary-700: #334155;
            --secondary-800: #1e293b;
            --secondary-900: #0f172a;
            
            /* Success Colors */
            --success-50: #f0fdf4;
            --success-100: #dcfce7;
            --success-200: #bbf7d0;
            --success-300: #86efac;
            --success-400: #4ade80;
            --success-500: #22c55e;
            --success-600: #16a34a;
            --success-700: #15803d;
            --success-800: #166534;
            --success-900: #14532d;
            
            /* Warning Colors */
            --warning-50: #fffbeb;
            --warning-100: #fef3c7;
            --warning-200: #fde68a;
            --warning-300: #fcd34d;
            --warning-400: #fbbf24;
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            --warning-700: #b45309;
            --warning-800: #92400e;
            --warning-900: #78350f;
            
            /* Error Colors */
            --error-50: #fef2f2;
            --error-100: #fee2e2;
            --error-200: #fecaca;
            --error-300: #fca5a5;
            --error-400: #f87171;
            --error-500: #ef4444;
            --error-600: #dc2626;
            --error-700: #b91c1c;
            --error-800: #991b1b;
            --error-900: #7f1d1d;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            --gradient-secondary: linear-gradient(135deg, var(--secondary-500), var(--secondary-700));
            --gradient-success: linear-gradient(135deg, var(--success-500), var(--success-700));
            --gradient-warning: linear-gradient(135deg, var(--warning-500), var(--warning-700));
            --gradient-error: linear-gradient(135deg, var(--error-500), var(--error-700));
        }
        
        /* Modern component styles */
        .btn-primary {
            background: var(--gradient-primary);
            border: none;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.25);
        }
        
        .card-modern {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease;
        }
        
        .card-modern:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        .input-modern {
            border: 2px solid var(--secondary-200);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .input-modern:focus {
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        /* Loading states */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Status indicators */
        .status-success { color: var(--success-600); }
        .status-warning { color: var(--warning-600); }
        .status-error { color: var(--error-600); }
        .status-info { color: var(--primary-600); }
        
        /* Modern form styles */
        .form-section {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--secondary-200);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .form-header {
            font-weight: 600;
            color: var(--secondary-800);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Collection select with search */
        .searchable-select {
            position: relative;
        }
        
        .searchable-select input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--secondary-200);
            border-radius: 8px;
            background: white;
        }
        
        /* Enhanced dropdown styles for better interaction */
        .searchable-select .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--secondary-200);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .searchable-select .dropdown-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid var(--secondary-100);
            transition: background-color 0.15s ease;
        }

        .searchable-select .dropdown-item:hover {
            background: var(--primary-50);
            color: var(--primary-700);
        }

        .searchable-select .dropdown-item:last-child {
            border-bottom: none;
        }

        /* Loading state for searchable selects */
        .searchable-select.loading input[type="text"] {
            background-image: url("data:image/svg+xml,%3csvg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='24px' height='30px' viewBox='0 0 24 30' style='enable-background:new 0 0 50 50;' xml:space='preserve'%3e%3crect x='0' y='13' width='4' height='5' fill='%23333'%3e%3canimate attributeName='height' attributeType='XML' values='5;21;5' begin='0s' dur='0.6s' repeatCount='indefinite' /%3e%3canimate attributeName='y' attributeType='XML' values='13; 5; 13' begin='0s' dur='0.6s' repeatCount='indefinite' /%3e%3c/rect%3e%3crect x='10' y='13' width='4' height='5' fill='%23333'%3e%3canimate attributeName='height' attributeType='XML' values='5;21;5' begin='0.15s' dur='0.6s' repeatCount='indefinite' /%3e%3canimate attributeName='y' attributeType='XML' values='13; 5; 13' begin='0.15s' dur='0.6s' repeatCount='indefinite' /%3e%3c/rect%3e%3crect x='20' y='13' width='4' height='5' fill='%23333'%3e%3canimate attributeName='height' attributeType='XML' values='5;21;5' begin='0.3s' dur='0.6s' repeatCount='indefinite' /%3e%3canimate attributeName='y' attributeType='XML' values='13; 5; 13' begin='0.3s' dur='0.6s' repeatCount='indefinite' /%3e%3c/rect%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 20px;
        }

        /* Enhanced visual feedback */
        .searchable-select input[type="text"]:focus {
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .searchable-select.has-selection input[type="text"] {
            border-color: var(--success-500);
            background-color: var(--success-50);
        }

    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        success: {
                            50: '#f0fdf4',
                            500: '#22c55e',
                            600: '#16a34a',
                        },
                        warning: {
                            50: '#fffbeb',
                            500: '#f59e0b',
                            600: '#d97706',
                        },
                        error: {
                            50: '#fef2f2',
                            500: '#ef4444',
                            600: '#dc2626',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-secondary-50 min-h-screen">
    <!-- Navigation with modern styling -->
    <nav class="bg-white shadow-sm border-b border-secondary-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center">
                            <span class="text-white font-bold text-sm">H</span>
                        </div>
                        <h1 class="text-xl font-semibold text-secondary-900">HistText Toolkit</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-secondary-500">v2.1.0</span>
                    <a href="/docs" class="text-primary-600 hover:text-primary-700 text-sm font-medium transition-colors">API Docs</a>
                    <button onclick="showHelp()" class="text-primary-600 hover:text-primary-700 text-sm font-medium transition-colors">
                        Help
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Status Banner -->
        <div id="status-banner" class="hidden mb-6"></div>
        
        <!-- Dashboard Cards with modern styling -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <!-- Configuration Card -->
            <div class="card-modern p-6 cursor-pointer group" onclick="showTab('config')">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary-500 to-primary-700 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                        </svg>
                    </div>
                    <div class="flex items-center">
                        <div id="config-status" class="w-3 h-3 rounded-full bg-secondary-300"></div>
                    </div>
                </div>
                <h3 class="font-semibold text-secondary-900 mb-2">Configuration</h3>
                <p class="text-sm text-secondary-600">Manage system settings and connections</p>
            </div>

            <!-- Upload Card -->
            <div class="card-modern p-6 cursor-pointer group" onclick="showTab('upload')">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-success-500 to-success-700 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                    </div>
                </div>
                <h3 class="font-semibold text-secondary-900 mb-2">Data Upload</h3>
                <p class="text-sm text-secondary-600">Import and manage your datasets</p>
            </div>

            <!-- NER Card -->
            <div class="card-modern p-6 cursor-pointer group" onclick="showTab('ner')">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-purple-700 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                        </svg>
                    </div>
                </div>
                <h3 class="font-semibold text-secondary-900 mb-2">NER</h3>
                <p class="text-sm text-secondary-600">Named entity recognition processing</p>
            </div>

            <!-- Tokenization Card -->
            <div class="card-modern p-6 cursor-pointer group" onclick="showTab('tokenize')">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-warning-500 to-warning-700 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </div>
                </div>
                <h3 class="font-semibold text-secondary-900 mb-2">Tokenization</h3>
                <p class="text-sm text-secondary-600">Text tokenization and processing</p>
            </div>

            <!-- Embeddings Card -->
            <div class="card-modern p-6 cursor-pointer group" onclick="showTab('embeddings')">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-indigo-700 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
                <h3 class="font-semibold text-secondary-900 mb-2">Embeddings</h3>
                <p class="text-sm text-secondary-600">Generate text embeddings and vectors</p>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="card-modern mb-6">
            <div class="border-b border-secondary-200">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                    <button id="tab-config" onclick="showTab('config')" class="tab-button active border-primary-500 text-primary-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all">
                        ‚öôÔ∏è Configuration
                    </button>
                    <button id="tab-upload" onclick="showTab('upload')" class="tab-button border-transparent text-secondary-500 hover:text-secondary-700 hover:border-secondary-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all">
                        üì§ Upload
                    </button>
                    <button id="tab-ner" onclick="showTab('ner')" class="tab-button border-transparent text-secondary-500 hover:text-secondary-700 hover:border-secondary-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all">
                        üè∑Ô∏è NER
                    </button>
                    <button id="tab-tokenize" onclick="showTab('tokenize')" class="tab-button border-transparent text-secondary-500 hover:text-secondary-700 hover:border-secondary-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all">
                        üî§ Tokenization
                    </button>
                    <button id="tab-embeddings" onclick="showTab('embeddings')" class="tab-button border-transparent text-secondary-500 hover:text-secondary-700 hover:border-secondary-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all">
                        üéØ Embeddings
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Configuration Tab -->
                <div id="config-tab" class="tab-content">
                    <h3 class="text-lg font-semibold text-secondary-900 mb-6">Configuration Management</h3>
                    
                    <!-- Connection Status -->
                    <div id="connection-status" class="form-section mb-6">
                        <div class="form-header">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            System Status
                        </div>
                        <div id="solr-status" class="flex items-center gap-3 p-3 bg-secondary-50 rounded-lg">
                            <div class="loading-spinner w-5 h-5 border-2 border-primary-200 border-t-primary-600 rounded-full"></div>
                            <span class="text-secondary-600">Checking Solr connection...</span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Create Config -->
                        <div class="form-section">
                            <div class="form-header">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Create Configuration
                            </div>
                            <form hx-post="/api/config/create" hx-target="#config-result" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Config Path</label>
                                    <input name="config_path" type="text" placeholder="./config.yaml" 
                                           class="input-modern w-full px-3 py-2 focus:outline-none" required>
                                </div>
                                <button type="submit" class="btn-primary w-full text-white py-2 px-4 rounded-lg font-medium">
                                    Create Configuration
                                </button>
                            </form>
                        </div>

                        <!-- Show Config -->
                        <div class="form-section">
                            <div class="form-header">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                                View Configuration
                            </div>
                            <form hx-post="/api/config/show" hx-target="#config-result" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Config Path (optional)</label>
                                    <input name="config_path" type="text" placeholder="Leave empty for current config" 
                                           class="input-modern w-full px-3 py-2 focus:outline-none">
                                </div>
                                <button type="submit" class="w-full bg-secondary-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-secondary-700 transition-colors">
                                    Show Configuration
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="form-section">
                        <div class="form-header">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Quick Actions
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="loadCurrentConfig()" class="bg-success-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-success-700 transition-colors">
                                Load Current Config
                            </button>
                            <button onclick="testSolrConnection()" class="bg-primary-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-primary-700 transition-colors">
                                Test Solr Connection
                            </button>
                            <button onclick="clearResults()" class="bg-secondary-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-secondary-700 transition-colors">
                                Clear Results
                            </button>
                        </div>
                    </div>

                    <!-- Results -->
                    <div id="config-result" class="mt-6"></div>
                </div>

                <!-- Upload Tab -->
                <div id="upload-tab" class="tab-content hidden">
                    <h3 class="text-lg font-semibold text-secondary-900 mb-6">Data Upload</h3>
                    
                    <!-- Enhanced JSONL Upload -->
                    <div class="form-section">
                        <div class="form-header">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Upload JSONL Files
                        </div>
                        <form hx-post="/api/upload/jsonl" hx-target="#upload-result" hx-encoding="multipart/form-data" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Collection Name *</label>
                                    <input name="collection" type="text" required placeholder="my_collection"
                                           class="input-modern w-full px-3 py-2 focus:outline-none">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Batch Size</label>
                                    <input name="batch_size" type="number" value="1000" min="1" max="10000"
                                           class="input-modern w-full px-3 py-2 focus:outline-none">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-2">JSONL Files *</label>
                                <div class="border-2 border-dashed border-secondary-300 rounded-lg p-6 text-center hover:border-primary-400 transition-colors">
                                    <input name="jsonl_files" type="file" accept=".jsonl" multiple required
                                           class="hidden" id="jsonl-files">
                                    <label for="jsonl-files" class="cursor-pointer">
                                        <svg class="mx-auto h-12 w-12 text-secondary-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <div class="mt-2">
                                            <span class="text-primary-600 font-medium">Click to upload</span> or drag and drop
                                        </div>
                                        <p class="text-secondary-500 text-sm">JSONL files only</p>
                                    </label>
                                </div>
                                <div id="file-list" class="mt-2"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-2">Schema File (optional)</label>
                                <input name="schema" type="file" accept=".yaml,.yml,.json"
                                       class="input-modern w-full px-3 py-2 focus:outline-none">
                                <p class="text-sm text-secondary-500 mt-1">Upload a schema file to validate your data structure</p>
                            </div>
                            
                            <button type="submit" class="btn-primary w-full text-white py-3 px-6 rounded-lg font-medium">
                                Upload Files
                            </button>
                        </form>
                    </div>

                    <div id="upload-result" class="mt-6"></div>
                </div>

                <!-- NER Tab with improved loading states -->
                <div id="ner-tab" class="tab-content hidden">
                    <h3 class="text-lg font-semibold text-secondary-900 mb-6">Named Entity Recognition</h3>
                    
                    <form hx-post="/api/ner/process" hx-target="#ner-result" class="space-y-6" onsubmit="return validateFormBeforeSubmit(this)">
                        <!-- Basic Configuration -->
                        <div class="form-section">
                            <div class="form-header">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Basic Configuration
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Collection *</label>
                                    <div id="ner-collection-container">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Text Field *</label>
                                    <div id="ner-field-container">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Filter Query</label>
                                    <input name="filter_query" type="text" placeholder="*:* or field:value"
                                        class="input-modern w-full px-3 py-2 focus:outline-none">
                                </div>
                            </div>
                        </div>

                        <!-- Model Configuration -->
                        <div class="form-section">
                            <div class="form-header">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                Model Configuration
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Model Type</label>
                                    <select name="model_type" id="ner-model-type" onchange="loadNerModels(); updateEntityTypes()" 
                                            class="input-modern w-full px-3 py-2 focus:outline-none">
                                        <option value="transformers">Transformers</option>
                                        <option value="gliner">GLiNER</option>
                                        <option value="spacy">spaCy</option>
                                        <option value="flair">Flair</option>
                                        <option value="stanza">Stanza</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Model Name *</label>
                                    <select name="model_name" id="ner-model-name" required
                                            class="input-modern w-full px-3 py-2 focus:outline-none">
                                        <option value="">Loading models...</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-secondary-700 mb-2">Entity Types (optional)</label>
                                <div class="flex gap-2">
                                    <input name="entity_types" id="ner-entity-types" type="text" placeholder="Leave empty for all types, or specify: PERSON,LOCATION,ORGANIZATION"
                                        class="input-modern flex-1 px-3 py-2 focus:outline-none">
                                    <button type="button" onclick="showEntityTypePicker()" 
                                            class="px-4 py-2 bg-primary-100 text-primary-700 rounded-lg hover:bg-primary-200 transition-colors">
                                        Pick Types
                                    </button>
                                </div>
                                <p class="text-xs text-secondary-500 mt-1">Leave empty to extract all entity types supported by the model</p>
                            </div>
                        </div>

                   <!-- Processing Parameters -->
                   <div class="form-section">
                       <div class="form-header">
                           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                           </svg>
                           Processing Parameters
                       </div>
                       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                           <div>
                               <label class="block text-sm font-medium text-secondary-700 mb-2">Start Index</label>
                               <input name="start" type="number" value="0" min="0"
                                   class="input-modern w-full px-3 py-2 focus:outline-none">
                           </div>
                           <div>
                               <label class="block text-sm font-medium text-secondary-700 mb-2">Batch Size</label>
                               <input name="batch_size" type="number" value="10000" min="1" max="100000"
                                   class="input-modern w-full px-3 py-2 focus:outline-none">
                           </div>
                           <div>
                               <label class="block text-sm font-medium text-secondary-700 mb-2">Max Batches</label>
                               <input name="num_batches" type="number" placeholder="All" min="1"
                                   class="input-modern w-full px-3 py-2 focus:outline-none">
                           </div>
                           <div>
                               <label class="block text-sm font-medium text-secondary-700 mb-2">Threshold</label>
                               <input name="threshold" type="number" step="0.01" value="0.5" min="0" max="1"
                                   class="input-modern w-full px-3 py-2 focus:outline-none">
                           </div>
                       </div>
                       
                       <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                           <div class="flex items-center">
                               <input name="use_gpu" type="checkbox" id="ner-gpu" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-secondary-300 rounded">
                               <label for="ner-gpu" class="ml-2 text-sm text-secondary-700">Use GPU acceleration</label>
                           </div>
                           <div class="flex items-center">
                               <input name="compact_labels" type="checkbox" id="ner-compact" checked class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-secondary-300 rounded">
                               <label for="ner-compact" class="ml-2 text-sm text-secondary-700">Use compact labels</label>
                           </div>
                           <div class="flex items-center">
                               <input name="label_stats" type="checkbox" id="ner-stats" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-secondary-300 rounded">
                               <label for="ner-stats" class="ml-2 text-sm text-secondary-700">Include label statistics</label>
                           </div>
                       </div>
                   </div>

                   <!-- Submit Button with Loading State -->
                   <div class="flex gap-4">
                       <button type="submit" id="ner-submit-btn" class="btn-primary text-white py-3 px-8 rounded-lg font-medium flex items-center gap-2">
                           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                           </svg>
                           Start NER Processing
                       </button>
                       <button type="button" onclick="clearResults()" class="bg-secondary-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-secondary-700 transition-colors">
                           Clear Results
                       </button>
                       <button type="button" onclick="resetNerForm()" class="bg-warning-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-warning-700 transition-colors">
                           Reset Form
                       </button>
                   </div>
               </form>

               <!-- Processing State Indicator -->
               <div id="ner-processing-state" class="hidden mt-6 form-section">
                   <div class="flex items-center gap-3">
                       <div class="loading-spinner w-6 h-6 border-2 border-primary-200 border-t-primary-600 rounded-full"></div>
                       <div>
                           <h4 class="font-medium text-secondary-900">Processing Request</h4>
                           <p class="text-sm text-secondary-600">Initializing NER processing...</p>
                       </div>
                   </div>
               </div>

               <div id="ner-result" class="mt-6"></div>
           </div>

           <!-- Tokenization Tab -->
            <div id="tokenize-tab" class="tab-content hidden">
                <h3 class="text-lg font-semibold text-secondary-900 mb-6">Text Tokenization</h3>
                
                <form hx-post="/api/tokenize/process" hx-target="#tokenize-result" class="space-y-6" onsubmit="return validateFormBeforeSubmit(this)">
                    <!-- Basic Configuration -->
                    <div class="form-section">
                        <div class="form-header">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Basic Configuration
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-2">Collection *</label>
                                <div id="tokenize-collection-container">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-2">Text Field *</label>
                                <div id="tokenize-field-container">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-2">Filter Query</label>
                                <input name="filter_query" type="text" placeholder="*:* or field:value"
                                    class="input-modern w-full px-3 py-2 focus:outline-none">
                                <p class="text-xs text-secondary-500 mt-1">Optional Solr query to filter documents</p>
                            </div>
                        </div>
                    </div>

                    <!-- Model Configuration -->
                    <div class="form-section">
                        <div class="form-header">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            Model Configuration
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-2">Model Type</label>
                                <select name="model_type" id="tokenize-model-type" onchange="updateTokenizeModelHints()"
                                        class="input-modern w-full px-3 py-2 focus:outline-none">
                                    <option value="transformers">Transformers</option>
                                    <option value="spacy">spaCy</option>
                                    <option value="chinese_segmenter">Chinese Segmenter</option>
                                </select>
                                <p class="text-xs text-secondary-500 mt-1">Type of tokenization model to use</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-2">Model Name</label>
                                <input name="model_name" type="text" id="tokenize-model-name" placeholder="bert-base-cased"
                                    class="input-modern w-full px-3 py-2 focus:outline-none">
                                <p class="text-xs text-secondary-500 mt-1" id="tokenize-model-hint">
                                    Model name or path (leave empty for Chinese segmenter)
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Processing Parameters -->
                    <div class="form-section">
                        <div class="form-header">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                            </svg>
                            Processing Parameters
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-2">Start Index</label>
                                <input name="start" type="number" value="0" min="0"
                                    class="input-modern w-full px-3 py-2 focus:outline-none">
                                <p class="text-xs text-secondary-500 mt-1">Starting document index</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-2">Batch Size</label>
                                <input name="batch_size" type="number" value="1000" min="1" max="10000"
                                    class="input-modern w-full px-3 py-2 focus:outline-none">
                                <p class="text-xs text-secondary-500 mt-1">Documents processed per batch</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-2">Max Batches</label>
                                <input name="num_batches" type="number" placeholder="All" min="1"
                                    class="input-modern w-full px-3 py-2 focus:outline-none">
                                <p class="text-xs text-secondary-500 mt-1">Limit number of batches (optional)</p>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="flex items-center">
                                <input name="simplify_chinese" type="checkbox" id="tokenize-chinese" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-secondary-300 rounded">
                                <label for="tokenize-chinese" class="ml-2 text-sm text-secondary-700">Convert traditional Chinese to simplified Chinese</label>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex gap-4">
                        <button type="submit" id="tokenize-submit-btn" class="btn-primary text-white py-3 px-8 rounded-lg font-medium flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                            Start Tokenization
                        </button>
                        <button type="button" onclick="clearResults()" class="bg-secondary-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-secondary-700 transition-colors">
                            Clear Results
                        </button>
                        <button type="button" onclick="resetTokenizeForm()" class="bg-warning-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-warning-700 transition-colors">
                            Reset Form
                        </button>
                    </div>
                </form>

                <!-- Processing State Indicator -->
                <div id="tokenize-processing-state" class="hidden mt-6 form-section">
                    <div class="flex items-center gap-3">
                        <div class="loading-spinner w-6 h-6 border-2 border-primary-200 border-t-primary-600 rounded-full"></div>
                        <div>
                            <h4 class="font-medium text-secondary-900">Processing Request</h4>
                            <p class="text-sm text-secondary-600">Initializing tokenization...</p>
                        </div>
                    </div>
                </div>

                <div id="tokenize-result" class="mt-6"></div>
            </div>

           <!-- Embeddings Tab -->
           <div id="embeddings-tab" class="tab-content hidden">
               <h3 class="text-lg font-semibold text-secondary-900 mb-6">Text Embeddings</h3>
               
               <!-- Sub-navigation for embedding types -->
               <div class="mb-6">
                   <div class="border-b border-secondary-200">
                       <nav class="-mb-px flex space-x-8">
                           <button onclick="showEmbeddingType('document')" id="doc-embeddings-tab" class="embedding-tab-button active border-primary-500 text-primary-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition-all">
                               üéØ Document Embeddings
                           </button>
                           <button onclick="showEmbeddingType('word')" id="word-embeddings-tab" class="embedding-tab-button border-transparent text-secondary-500 hover:text-secondary-700 hover:border-secondary-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition-all">
                               üìà Word Embeddings
                           </button>
                       </nav>
                   </div>
               </div>

               <!-- Document Embeddings Content -->
                <div id="document-embeddings-content" class="embedding-type-content">
                    <form hx-post="/api/embeddings/compute" hx-target="#embeddings-result" class="space-y-6" onsubmit="return validateFormBeforeSubmit(this)">
                        <!-- Basic Configuration -->
                        <div class="form-section">
                            <div class="form-header">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Basic Configuration
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Collection *</label>
                                    <div id="embeddings-collection-container">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Text Field *</label>
                                    <div id="embeddings-field-container">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Output Path *</label>
                                    <input name="output_path" type="text" required placeholder="/path/to/embeddings.vec"
                                        class="input-modern w-full px-3 py-2 focus:outline-none">
                                    <p class="text-xs text-secondary-500 mt-1">Where to save the computed embeddings</p>
                                </div>
                            </div>
                        </div>

                        <!-- Model Configuration -->
                        <div class="form-section">
                            <div class="form-header">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                Model Configuration
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Model Type</label>
                                    <select name="model_type" id="embeddings-model-type" onchange="updateEmbeddingsModelHints()"
                                            class="input-modern w-full px-3 py-2 focus:outline-none">
                                        <option value="fasttext">FastText</option>
                                        <option value="word2vec">Word2Vec</option>
                                        <option value="sentence_transformers">Sentence Transformers</option>
                                    </select>
                                    <p class="text-xs text-secondary-500 mt-1">Type of embeddings model</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Model Name *</label>
                                    <input name="model_name" type="text" required id="embeddings-model-name" placeholder="fasttext-wiki"
                                        class="input-modern w-full px-3 py-2 focus:outline-none">
                                    <p class="text-xs text-secondary-500 mt-1" id="embeddings-model-hint">
                                        Model name or path to use for embeddings
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Dimensions</label>
                                    <input name="dim" type="number" placeholder="300" min="50" max="1000"
                                        class="input-modern w-full px-3 py-2 focus:outline-none">
                                    <p class="text-xs text-secondary-500 mt-1">Embedding dimensions (optional)</p>
                                </div>
                            </div>
                        </div>

                        <!-- Processing Parameters -->
                        <div class="form-section">
                            <div class="form-header">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                                </svg>
                                Processing Parameters
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Start Index</label>
                                    <input name="start" type="number" value="0" min="0"
                                        class="input-modern w-full px-3 py-2 focus:outline-none">
                                    <p class="text-xs text-secondary-500 mt-1">Starting document index</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Batch Size</label>
                                    <input name="batch_size" type="number" value="1000" min="1" max="10000"
                                        class="input-modern w-full px-3 py-2 focus:outline-none">
                                    <p class="text-xs text-secondary-500 mt-1">Documents per batch</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Max Batches</label>
                                    <input name="num_batches" type="number" placeholder="All" min="1"
                                        class="input-modern w-full px-3 py-2 focus:outline-none">
                                    <p class="text-xs text-secondary-500 mt-1">Limit batches (optional)</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Output Format</label>
                                    <select name="output_format" 
                                            class="input-modern w-full px-3 py-2 focus:outline-none">
                                        <option value="vec">Vec Format</option>
                                        <option value="txt">Text Format</option>
                                        <option value="binary">Binary Format</option>
                                        <option value="json">JSON Format</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mt-4 space-y-3">
                                <div class="flex items-center">
                                    <input name="simplify_chinese" type="checkbox" id="doc-embeddings-chinese" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-secondary-300 rounded">
                                    <label for="doc-embeddings-chinese" class="ml-2 text-sm text-secondary-700">Convert traditional Chinese to simplified Chinese</label>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Filter Query</label>
                                    <input name="filter_query" type="text" placeholder="*:* or field:value"
                                        class="input-modern w-full px-3 py-2 focus:outline-none">
                                    <p class="text-xs text-secondary-500 mt-1">Optional Solr query to filter documents</p>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex gap-4">
                            <button type="submit" id="doc-embeddings-submit-btn" class="btn-primary text-white py-3 px-8 rounded-lg font-medium flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Compute Document Embeddings
                            </button>
                            <button type="button" onclick="clearResults()" class="bg-secondary-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-secondary-700 transition-colors">
                                Clear Results
                            </button>
                            <button type="button" onclick="resetDocumentEmbeddingsForm()" class="bg-warning-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-warning-700 transition-colors">
                                Reset Form
                            </button>
                        </div>
                    </form>
                </div>

               <!-- Word Embeddings Content -->
                <div id="word-embeddings-content" class="embedding-type-content hidden">
                    <form hx-post="/api/embeddings/compute-word" hx-target="#embeddings-result" class="space-y-6" onsubmit="return validateFormBeforeSubmit(this)">
                        <!-- Basic Configuration -->
                        <div class="form-section">
                            <div class="form-header">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Basic Configuration
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Collection *</label>
                                    <div id="word-embeddings-collection-container">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Text Field *</label>
                                    <div id="word-embeddings-field-container">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Output Path *</label>
                                    <input name="output_path" type="text" required placeholder="/path/to/word_embeddings.txt"
                                        class="input-modern w-full px-3 py-2 focus:outline-none">
                                    <p class="text-xs text-secondary-500 mt-1">Where to save the trained word embeddings</p>
                                </div>
                            </div>
                        </div>

                        <!-- Training Configuration -->
                        <div class="form-section">
                            <div class="form-header">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                Training Configuration
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Method</label>
                                    <select name="method" id="word-embeddings-method" onchange="updateWordEmbeddingsHints()"
                                            class="input-modern w-full px-3 py-2 focus:outline-none">
                                        <option value="word2vec">Word2Vec</option>
                                        <option value="fasttext">FastText</option>
                                    </select>
                                    <p class="text-xs text-secondary-500 mt-1">Word embedding algorithm</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Dimensions</label>
                                    <input name="dim" type="number" value="100" min="50" max="1000"
                                        class="input-modern w-full px-3 py-2 focus:outline-none" id="word-dim-input">
                                    <p class="text-xs text-secondary-500 mt-1">Vector dimensions (50-1000)</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Context Window</label>
                                    <input name="window" type="number" value="5" min="1" max="20"
                                        class="input-modern w-full px-3 py-2 focus:outline-none" id="word-window-input">
                                    <p class="text-xs text-secondary-500 mt-1">Context window size</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Min Count</label>
                                    <input name="min_count" type="number" value="5" min="1"
                                        class="input-modern w-full px-3 py-2 focus:outline-none" id="word-mincount-input">
                                    <p class="text-xs text-secondary-500 mt-1">Minimum word frequency</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Workers</label>
                                    <input name="workers" type="number" value="4" min="1" max="16"
                                        class="input-modern w-full px-3 py-2 focus:outline-none" id="word-workers-input">
                                    <p class="text-xs text-secondary-500 mt-1">Number of training threads</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Batch Size</label>
                                    <input name="batch_size" type="number" value="1000" min="1" max="10000"
                                        class="input-modern w-full px-3 py-2 focus:outline-none">
                                    <p class="text-xs text-secondary-500 mt-1">Documents per batch</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-secondary-700 mb-2">Output Format</label>
                                    <select name="output_format" 
                                            class="input-modern w-full px-3 py-2 focus:outline-none">
                                        <option value="txt">Text Format</option>
                                        <option value="vec">Vec Format</option>
                                        <option value="bin">Binary Format</option>
                                        <option value="gensim">Gensim Format</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Options -->
                        <div class="form-section">
                            <div class="form-header">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                                </svg>
                                Advanced Options
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <input name="auto_configure" type="checkbox" id="word-auto-configure" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-secondary-300 rounded" onchange="toggleAutoConfigureHint()">
                                    <label for="word-auto-configure" class="ml-2 text-sm text-secondary-700 font-medium">üéØ Auto-Configure Parameters</label>
                                </div>
                                
                                <div id="auto-configure-hint" class="hidden bg-primary-50 border border-primary-200 rounded-lg p-4 text-sm text-primary-700">
                                    <p class="font-medium mb-2">Auto-Configure will:</p>
                                    <ul class="list-disc ml-4 space-y-1">
                                        <li>Analyze your collection to determine optimal dimensions</li>
                                        <li>Set appropriate window size based on document length</li>
                                        <li>Adjust min_count based on vocabulary size</li>
                                        <li>Optimize worker count for your system</li>
                                        <li>Choose the best method based on data characteristics</li>
                                    </ul>
                                    <p class="mt-2 text-xs text-primary-600"><strong>Note:</strong> Manual parameters will be disabled when auto-configure is enabled.</p>
                                </div>
                                
                                <div class="flex items-center">
                                    <input name="simplify_chinese" type="checkbox" id="word-embeddings-chinese" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-secondary-300 rounded">
                                    <label for="word-embeddings-chinese" class="ml-2 text-sm text-secondary-700">Convert traditional Chinese to simplified Chinese</label>
                                </div>
                                
                                <div class="flex items-center">
                                    <input name="no_header" type="checkbox" id="word-no-header" class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-secondary-300 rounded">
                                    <label for="word-no-header" class="ml-2 text-sm text-secondary-700">Exclude header from output file</label>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-secondary-700 mb-2">Filter Query</label>
                                <input name="filter_query" type="text" placeholder="*:* or field:value"
                                    class="input-modern w-full px-3 py-2 focus:outline-none">
                                <p class="text-xs text-secondary-500 mt-1">Optional Solr query to filter documents</p>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex gap-4">
                            <button type="submit" id="word-embeddings-submit-btn" class="bg-gradient-to-r from-yellow-500 to-yellow-700 text-white py-3 px-8 rounded-lg font-medium flex items-center gap-2 hover:from-yellow-600 hover:to-yellow-800 transition-all">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                                Train Word Embeddings
                            </button>
                            <button type="button" onclick="clearResults()" class="bg-secondary-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-secondary-700 transition-colors">
                                Clear Results
                            </button>
                            <button type="button" onclick="resetWordEmbeddingsForm()" class="bg-warning-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-warning-700 transition-colors">
                                Reset Form
                            </button>
                        </div>
                    </form>
                </div>

               <!-- Processing State Indicator -->
               <div id="embeddings-processing-state" class="hidden mt-6 form-section">
                   <div class="flex items-center gap-3">
                       <div class="loading-spinner w-6 h-6 border-2 border-primary-200 border-t-primary-600 rounded-full"></div>
                       <div>
                           <h4 class="font-medium text-secondary-900">Processing Request</h4>
                           <p class="text-sm text-secondary-600">Initializing embeddings computation...</p>
                       </div>
                   </div>
               </div>

               <div id="word-embeddings-processing-state" class="hidden mt-6 form-section">
                   <div class="flex items-center gap-3">
                       <div class="loading-spinner w-6 h-6 border-2 border-yellow-200 border-t-yellow-600 rounded-full"></div>
                       <div>
                           <h4 class="font-medium text-secondary-900">Processing Request</h4>
                           <p class="text-sm text-secondary-600">Initializing word embeddings training...</p>
                       </div>
                   </div>
               </div>

               <div id="embeddings-result" class="mt-6"></div>
           </div>
       </div>

       <!-- Quick Actions Panel -->
       <div class="card-modern p-6 mt-8">
           <h3 class="text-lg font-semibold text-secondary-900 mb-4">Quick Actions</h3>
           <div class="flex flex-wrap gap-3">
               <button onclick="checkHealth()" class="bg-success-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-success-700 transition-colors flex items-center gap-2">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                   </svg>
                   Health Check
               </button>
               <button hx-get="/api/models/list" hx-target="#quick-result" class="bg-primary-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-primary-700 transition-colors flex items-center gap-2">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                   </svg>
                   List Models
               </button>
               <a href="/docs" target="_blank" class="bg-purple-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-purple-700 transition-colors flex items-center gap-2">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                   </svg>
                   API Documentation
               </a>
               <button onclick="clearAllResults()" class="bg-secondary-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-secondary-700 transition-colors flex items-center gap-2">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                   </svg>
                   Clear All Results
               </button>
           </div>
           <div id="quick-result" class="mt-4"></div>
       </div>
   </div>

   <!-- Enhanced JavaScript with improved UX -->
   <script>
       // Global state management
       let collections = [];
       let availableModels = {};
       let availableEntityTypes = {};
       let selectedEntityTypes = [];
       let currentProcessingTasks = new Set();

       // Initialize application
       document.addEventListener('DOMContentLoaded', function() {
           initializeApp();
       });

       async function initializeApp() {
           showStatusBanner('Initializing application...', 'info');
           
           // Check system status
           await checkSystemStatus();
           
           // Load initial data
           await loadInitialData();
           
           // Auto-load current config
           setTimeout(() => {
               loadCurrentConfig();
           }, 1000);

           hideStatusBanner();
       }

       async function checkSystemStatus() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout for initial check
                
                const response = await fetch('/health', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    updateConfigStatus('success');
                    // Test Solr connection after health check
                    await testSolrConnection();
                } else {
                    updateConfigStatus('warning');
                }
            } catch (error) {
                updateConfigStatus('error');
                console.error('Health check failed:', error);
                
                // Still try Solr connection even if health check fails
                try {
                    await testSolrConnection();
                } catch (solrError) {
                    console.error('Solr connection also failed:', solrError);
                }
            }
        }

       async function loadInitialData() {
           try {
               // Load collections for all tabs
               await Promise.all([
                   loadCollections(),
                   loadEntityTypes(),
                   loadNerModels()
               ]);
           } catch (error) {
               console.error('Failed to load initial data:', error);
               showStatusBanner('Failed to load some initial data. Some features may not work properly.', 'warning');
           }
       }

       // Modern tab switching
       function showTab(tabName) {
           // Hide all tab contents
           document.querySelectorAll('.tab-content').forEach(tab => {
               tab.classList.add('hidden');
           });
           
           // Remove active class from all tab buttons
           document.querySelectorAll('.tab-button').forEach(button => {
               button.classList.remove('active', 'border-primary-500', 'text-primary-600');
               button.classList.add('border-transparent', 'text-secondary-500');
           });
           
           // Show selected tab
           const targetTab = document.getElementById(tabName + '-tab');
           if (targetTab) {
               targetTab.classList.remove('hidden');
           }
           
           // Add active class to selected button
           const targetButton = document.getElementById('tab-' + tabName);
           if (targetButton) {
               targetButton.classList.remove('border-transparent', 'text-secondary-500');
               targetButton.classList.add('active', 'border-primary-500', 'text-primary-600');
           }

           // Initialize tab-specific data
           initializeTabData(tabName);
       }

       function initializeTabData(tabName) {
           switch(tabName) {
               case 'ner':
                   initializeNerTab();
                   break;
               case 'tokenize':
                   initializeTokenizeTab();
                   break;
               case 'embeddings':
                   initializeEmbeddingsTab();
                   break;
           }
       }

       // Enhanced status management
       function showStatusBanner(message, type = 'info') {
           const banner = document.getElementById('status-banner');
           const colors = {
               info: 'bg-primary-50 border-primary-200 text-primary-700',
               success: 'bg-success-50 border-success-200 text-success-700',
               warning: 'bg-warning-50 border-warning-200 text-warning-700',
               error: 'bg-error-50 border-error-200 text-error-700'
           };
           
           banner.className = `border-l-4 p-4 rounded-r-lg ${colors[type]}`;
           banner.innerHTML = `
               <div class="flex items-center">
                   <div class="ml-3">
                       <p class="text-sm font-medium">${message}</p>
                   </div>
                   <div class="ml-auto pl-3">
                       <button onclick="hideStatusBanner()" class="text-sm underline">Dismiss</button>
                   </div>
               </div>
           `;
           banner.classList.remove('hidden');
       }

       function hideStatusBanner() {
           document.getElementById('status-banner').classList.add('hidden');
       }

       function updateConfigStatus(status) {
           const statusEl = document.getElementById('config-status');
           const colors = {
               success: 'bg-success-500',
               warning: 'bg-warning-500',
               error: 'bg-error-500'
           };
           
           statusEl.className = `w-3 h-3 rounded-full ${colors[status]}`;
       }

       // Enhanced collections loading with search
        function createSearchableSelect(containerId, placeholder, items, fieldName, defaultValue = null, onSelectCallback = null) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Determine default value
            let selectedValue = defaultValue;
            if (!selectedValue && items.length > 0) {
                if (fieldName && fieldName.includes('field')) {
                    // For text fields, prefer 'text' if available
                    selectedValue = items.includes('text') ? 'text' : items[0];
                } else {
                    // For collections, use first available
                    selectedValue = items[0];
                }
            }
            
            container.innerHTML = `
                <div class="searchable-select">
                    <input type="text" 
                        class="input-modern w-full px-3 py-2 focus:outline-none" 
                        placeholder="${placeholder}"
                        value="${selectedValue || ''}"
                        onkeyup="filterItems('${containerId}', this.value)"
                        onfocus="showDropdown('${containerId}')"
                        onblur="hideDropdownDelayed('${containerId}')"
                        onchange="updateHiddenInput('${containerId}')">
                    <input type="hidden" 
                        name="${fieldName}" 
                        value="${selectedValue || ''}">
                    
                    <!-- Preview of available items -->
                    <div class="mt-2 text-xs text-secondary-600">
                        Available (${items.length}): ${items.slice(0, 5).join(', ')}${items.length > 5 ? `, +${items.length - 5} more...` : ''}
                    </div>
                    
                    <div class="dropdown hidden" id="${containerId}-dropdown">
                        ${items.map(item => 
                            `<div class="dropdown-item" onclick="selectItem('${containerId}', '${item}', '${fieldName}')">${item}</div>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            // Store the callback for later use
            if (onSelectCallback) {
                container.dataset.onSelectCallback = onSelectCallback.name;
            }
        }
        function updateHiddenInput(containerId) {
            const textInput = document.querySelector(`#${containerId} input[type="text"]`);
            const hiddenInput = document.querySelector(`#${containerId} input[type="hidden"]`);
            
            if (textInput && hiddenInput) {
                const oldValue = hiddenInput.value;
                const newValue = textInput.value;
                
                hiddenInput.value = newValue;
                
                // If this is a collection field and the value changed, load fields
                if (containerId.includes('collection') && oldValue !== newValue && newValue) {
                    const type = containerId.replace('-collection-container', '');
                    console.log(`Collection changed from ${oldValue} to ${newValue} for type: ${type}`);
                    loadCollectionFields(newValue, type);
                }
            }
        }

        // Add event listeners for better interaction
        document.addEventListener('click', function(e) {
            // Close all dropdowns when clicking outside
            if (!e.target.closest('.searchable-select')) {
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    dropdown.classList.add('hidden');
                });
            }
        });
        // Enhanced collection loading with immediate UI update
        async function loadCollections() {
            try {
                showStatusBanner('Loading collections...', 'info');
                
                // Add loading state to all collection containers
                const collectionContainers = [
                    'ner-collection-container',
                    'tokenize-collection-container',
                    'embeddings-collection-container',
                    'word-embeddings-collection-container'
                ];
                
                collectionContainers.forEach(containerId => {
                    const container = document.getElementById(containerId);
                    if (container) {
                        container.innerHTML = `
                            <div class="searchable-select loading">
                                <input type="text" 
                                    class="input-modern w-full px-3 py-2 focus:outline-none" 
                                    placeholder="Loading collections..."
                                    disabled>
                                <input type="hidden" name="collection">
                                <div class="mt-2 text-xs text-secondary-600">Loading...</div>
                            </div>
                        `;
                    }
                });
                
                const response = await fetch('/api/ner/collections');
                const data = await response.json();
                
                if (data.collections && data.collections.length > 0) {
                    collections = data.collections;
                    console.log(`Loaded ${collections.length} collections:`, collections);
                    
                    populateAllCollectionSearches();
                    showStatusBanner(`Loaded ${collections.length} collections`, 'success');
                    setTimeout(hideStatusBanner, 2000);
                } else {
                    collections = [];
                    
                    // Show error state in containers
                    collectionContainers.forEach(containerId => {
                        const container = document.getElementById(containerId);
                        if (container) {
                            container.innerHTML = `
                                <div class="searchable-select error">
                                    <input type="text" 
                                        class="input-modern w-full px-3 py-2 focus:outline-none border-error-300" 
                                        placeholder="No collections found"
                                        disabled>
                                    <input type="hidden" name="collection">
                                    <div class="mt-2 text-xs text-error-600">
                                        ${data.error ? 'Connection error: ' + data.error : 'No collections available'}
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    if (data.error) {
                        showStatusBanner('Solr connection error: ' + data.error, 'error');
                    } else {
                        showStatusBanner('No collections found', 'warning');
                    }
                }
            } catch (error) {
                console.error('Error loading collections:', error);
                collections = [];
                showStatusBanner('Failed to load collections. Please check your Solr connection.', 'error');
            }
        }

       function populateAllCollectionSearches() {
            const searchConfigs = [
                { 
                    containerId: 'ner-collection-container', 
                    fieldName: 'collection',
                    type: 'ner'
                },
                { 
                    containerId: 'tokenize-collection-container', 
                    fieldName: 'collection',
                    type: 'tokenize'
                },
                { 
                    containerId: 'embeddings-collection-container', 
                    fieldName: 'collection',
                    type: 'embeddings'
                },
                { 
                    containerId: 'word-embeddings-collection-container', 
                    fieldName: 'collection',
                    type: 'word-embeddings'
                }
            ];
            
            searchConfigs.forEach(config => {
                createSearchableSelect(
                    config.containerId,
                    'Search collections...',
                    collections,
                    config.fieldName,
                    collections[0] || null // Auto-select first collection
                );
            });
            
            // Auto-load fields for the first collection if available
            if (collections.length > 0) {
                searchConfigs.forEach(config => {
                    loadCollectionFields(collections[0], config.type);
                });
            }
        }

        function populateCollectionSearches() {
           const searchIds = ['ner-collection', 'tokenize-collection', 'embeddings-collection', 'word-embeddings-collection'];
           
           searchIds.forEach(id => {
               const dropdown = document.getElementById(id + '-dropdown');
               if (dropdown) {
                   dropdown.innerHTML = collections.map(collection => 
                       `<div class="dropdown-item" onclick="selectCollection('${id}', '${collection}')">${collection}</div>`
                   ).join('');
               }
           });
       }


       function filterCollections(type) {
           const searchInput = document.getElementById(type + '-collection-search');
           const dropdown = document.getElementById(type + '-collection-dropdown');
           const query = searchInput.value.toLowerCase();
           
           if (query.length === 0) {
               dropdown.classList.add('hidden');
               return;
           }
           
           const filtered = collections.filter(collection => 
               collection.toLowerCase().includes(query)
           );
           
           dropdown.innerHTML = filtered.map(collection => 
               `<div class="dropdown-item" onclick="selectCollection('${type}-collection', '${collection}')">${collection}</div>`
           ).join('');
           
           dropdown.classList.remove('hidden');
       }

       function selectCollection(type, collection) {
           const searchInput = document.getElementById(type + '-search');
           const valueInput = document.getElementById(type + '-value');
           const dropdown = document.getElementById(type + '-dropdown');
           
           searchInput.value = collection;
           valueInput.value = collection;
           dropdown.classList.add('hidden');
           
           // Load fields for this collection
           loadCollectionFields(collection, type.replace('-collection', ''));
       }

       async function loadCollectionFields(collection, type) {
            if (!collection) {
                console.log(`No collection provided for type: ${type}`);
                return;
            }
            
            console.log(`Loading fields for collection: ${collection}, type: ${type}`);
            
            try {
                showStatusBanner(`Loading fields for ${collection}...`, 'info');
                
                const response = await fetch(`/api/ner/collections/${collection}/fields`);
                const data = await response.json();
                
                const fieldContainerMap = {
                    'ner': 'ner-field-container',
                    'tokenize': 'tokenize-field-container',
                    'embeddings': 'embeddings-field-container',
                    'word-embeddings': 'word-embeddings-field-container'
                };
                
                const fieldContainerId = fieldContainerMap[type];
                if (!fieldContainerId) {
                    console.error(`No field container found for type: ${type}`);
                    return;
                }
                
                const fields = data.fields && data.fields.length > 0 ? data.fields : ['text', 'content', 'body', 'title'];
                console.log(`Loaded fields for ${collection}:`, fields);
                
                // Prefer 'text' field if available, otherwise use first field
                const defaultField = fields.includes('text') ? 'text' : fields[0];
                
                createSearchableSelect(
                    fieldContainerId,
                    'Search fields...',
                    fields,
                    'text_field',
                    defaultField
                );
                
                hideStatusBanner();
                console.log(`Fields loaded successfully for ${type}: ${fields.join(', ')}`);
                
            } catch (error) {
                console.error(`Error loading fields for ${type}:`, error);
                
                // Fallback to common field names
                const fieldContainerMap = {
                    'ner': 'ner-field-container',
                    'tokenize': 'tokenize-field-container',
                    'embeddings': 'embeddings-field-container',
                    'word-embeddings': 'word-embeddings-field-container'
                };
                
                const fieldContainerId = fieldContainerMap[type];
                if (fieldContainerId) {
                    const fallbackFields = ['text', 'content', 'body', 'title'];
                    console.log(`Using fallback fields for ${type}:`, fallbackFields);
                    
                    createSearchableSelect(
                        fieldContainerId,
                        'Search fields...',
                        fallbackFields,
                        'text_field',
                        'text'
                    );
                }
                
                showStatusBanner(`Failed to load fields for ${collection}, using defaults`, 'warning');
                setTimeout(hideStatusBanner, 3000);
            }
        }
        function validateFormBeforeSubmit(form) {
            event.preventDefault();
            
            // Validate the form
            if (!validateForm(form)) {
                return false;
            }
            
            // Additional validation based on form type
            const formData = new FormData(form);
            
            // Check for specific requirements
            if (form.closest('#embeddings-tab')) {
                const outputPath = formData.get('output_path');
                if (!outputPath) {
                    showStatusBanner('Output path is required for embeddings', 'error');
                    return false;
                }
                
                const modelName = formData.get('model_name');
                if (!modelName) {
                    showStatusBanner('Model name is required for embeddings', 'error');
                    return false;
                }
            }
            
            if (form.closest('#tokenize-tab')) {
                const modelType = formData.get('model_type');
                const modelName = formData.get('model_name');
                
                if (modelType !== 'chinese_segmenter' && !modelName) {
                    showStatusBanner('Model name is required for this tokenization type', 'error');
                    return false;
                }
            }
            
            // Log form data for debugging
            console.log('Form data being submitted:');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            // All validation passed, proceed with HTMX submission
            htmx.trigger(form, 'submit');
            return false;
            }

            // Initialize hint updates on page load
            document.addEventListener('DOMContentLoaded', function() {
            // Set up model hint updates
            setTimeout(() => {
                updateTokenizeModelHints();
                updateEmbeddingsModelHints();
                updateWordEmbeddingsHints();
            }, 1000);
            });
        // Update the HTMX beforeRequest handler
        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            const form = evt.detail.elt;
            
            // Skip validation if this is coming from our validateFormBeforeSubmit
            if (evt.detail.trigger !== 'submit') {
                return;
            }
            
            // Find which processing type this is and clear its results
            let processingType = null;
            if (form.closest('#ner-tab')) processingType = 'ner';
            else if (form.closest('#tokenize-tab')) processingType = 'tokenize';
            else if (form.closest('#embeddings-tab')) {
                if (form.closest('#word-embeddings-content')) processingType = 'word-embeddings';
                else processingType = 'embeddings';
            }
            
            if (processingType) {
                clearResultsForType(processingType);
                showProcessingState(processingType);
            }
        });
        function filterItems(containerId, query) {
            const dropdown = document.getElementById(containerId + '-dropdown');
            if (!dropdown) return;
            
            const items = Array.from(dropdown.children);
            let visibleCount = 0;
            
            items.forEach(item => {
                if (item.textContent.toLowerCase().includes(query.toLowerCase())) {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Show dropdown if there's a query and visible items
            if (query.length > 0 && visibleCount > 0) {
                dropdown.classList.remove('hidden');
            } else if (query.length === 0) {
                // Show all items when query is empty
                items.forEach(item => item.style.display = 'block');
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }
        let dropdownTimeout;

        function showDropdown(containerId) {
            // Clear any pending hide timeout
            if (dropdownTimeout) {
                clearTimeout(dropdownTimeout);
                dropdownTimeout = null;
            }
            
            const dropdown = document.getElementById(containerId + '-dropdown');
            if (dropdown) {
                dropdown.classList.remove('hidden');
                
                // Show all items when dropdown is opened
                const items = Array.from(dropdown.children);
                items.forEach(item => item.style.display = 'block');
            }
        }

        function hideDropdownDelayed(containerId) {
            // Use a longer delay to allow for clicks
            dropdownTimeout = setTimeout(() => {
                const dropdown = document.getElementById(containerId + '-dropdown');
                if (dropdown) {
                    dropdown.classList.add('hidden');
                }
            }, 300);
        }


        function selectItem(containerId, item, fieldName) {
            const textInput = document.querySelector(`#${containerId} input[type="text"]`);
            const hiddenInput = document.querySelector(`#${containerId} input[type="hidden"]`);
            const dropdown = document.getElementById(containerId + '-dropdown');
            const container = document.getElementById(containerId);
            
            if (textInput) textInput.value = item;
            if (hiddenInput) hiddenInput.value = item;
            if (dropdown) dropdown.classList.add('hidden');
            
            // Trigger field loading for collections
            if (fieldName === 'collection') {
                const type = containerId.replace('-collection-container', '');
                console.log(`Collection selected: ${item} for type: ${type}`);
                loadCollectionFields(item, type);
            }
            
            // Execute custom callback if exists
            const callback = container?.dataset.onSelectCallback;
            if (callback && window[callback]) {
                window[callback](item, fieldName);
            }
        }
        function filterFields(type) {
           const searchInput = document.getElementById(type + '-field-search');
           const dropdown = document.getElementById(type + '-field-dropdown');
           const query = searchInput.value.toLowerCase();
           
           if (query.length === 0) {
               dropdown.classList.add('hidden');
               return;
           }
           
           dropdown.classList.remove('hidden');
       }

       function selectField(type, field) {
           const searchInput = document.getElementById(type + '-search');
           const valueInput = document.getElementById(type + '-value');
           const dropdown = document.getElementById(type + '-dropdown');
           
           searchInput.value = field;
           valueInput.value = field;
           dropdown.classList.add('hidden');
       }
       let activeProcessingTasks = new Map();
       // Enhanced processing state management
       function showProcessingState(type) {
            // Generate unique task ID for this processing run
            const taskId = `${type}-${Date.now()}`;
            activeProcessingTasks.set(type, taskId);
            
            const stateEl = document.getElementById(type + '-processing-state');
            const submitBtn = document.getElementById(type + '-submit-btn');
            
            if (stateEl) {
                stateEl.classList.remove('hidden');
                stateEl.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="loading-spinner w-6 h-6 border-2 border-primary-200 border-t-primary-600 rounded-full"></div>
                        <div>
                            <h4 class="font-medium text-secondary-900">Processing Request</h4>
                            <p class="text-sm text-secondary-600">Initializing ${type} processing...</p>
                            <p class="text-xs text-secondary-500 mt-1">Task ID: ${taskId}</p>
                        </div>
                    </div>
                `;
            }
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = `
                    <div class="loading-spinner w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
                    Processing...
                `;
            }
            
            showStatusBanner('Processing request... This may take a few moments.', 'info');
        }

        function hideProcessingState(type) {
            // Remove from active tasks
            activeProcessingTasks.delete(type);
            
            const stateEl = document.getElementById(type + '-processing-state');
            const submitBtn = document.getElementById(type + '-submit-btn');
            
            if (stateEl) {
                stateEl.classList.add('hidden');
            }
            
            if (submitBtn) {
                submitBtn.disabled = false;
                // Restore original button text based on type
                const buttonTexts = {
                    'ner': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> Start NER Processing',
                    'tokenize': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg> Start Tokenization',
                    'embeddings': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> Compute Document Embeddings',
                    'word-embeddings': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg> Train Word Embeddings'
                };
                submitBtn.innerHTML = buttonTexts[type] || 'Submit';
            }
            
            if (activeProcessingTasks.size === 0) {
                hideStatusBanner();
            }
        }

        // Enhanced HTMX event handlers with better state management
        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            const form = evt.detail.elt;
            
            // Find which processing type this is
            let processingType = null;
            if (form.closest('#ner-tab')) processingType = 'ner';
            else if (form.closest('#tokenize-tab')) processingType = 'tokenize';
            else if (form.closest('#embeddings-tab')) {
                if (form.closest('#word-embeddings-content')) processingType = 'word-embeddings';
                else processingType = 'embeddings';
            }
            
            if (processingType) {
                showProcessingState(processingType);
            }
            
            if (!validateForm(form)) {
                evt.preventDefault();
                if (processingType) {
                    hideProcessingState(processingType);
                }
                return;
            }
        });

        document.body.addEventListener('htmx:afterRequest', function(evt) {
            const form = evt.detail.elt;
            
            // Find which processing type this is
            let processingType = null;
            if (form.closest('#ner-tab')) processingType = 'ner';
            else if (form.closest('#tokenize-tab')) processingType = 'tokenize';
            else if (form.closest('#embeddings-tab')) {
                if (form.closest('#word-embeddings-content')) processingType = 'word-embeddings';
                else processingType = 'embeddings';
            }
            
            const xhr = evt.detail.xhr;
            
            // Check if this was a processing request that returns task tracking HTML
            if (xhr.responseText && xhr.responseText.includes('task-')) {
                // This is a background task, don't hide processing state yet
                // The task tracking will handle state management
                return;
            }
            
            // For other requests, hide processing state
            if (processingType) {
                hideProcessingState(processingType);
            }
        });

        document.body.addEventListener('htmx:responseError', function(evt) {
            showStatusBanner('Request failed. Please check your connection and try again.', 'error');
            
            // Hide any active processing states
            activeProcessingTasks.forEach((taskId, type) => {
                hideProcessingState(type);
            });
        });

        document.body.addEventListener('htmx:timeout', function(evt) {
            showStatusBanner('Request timed out. The operation may still be running in the background.', 'warning');
            
            // Don't hide processing states on timeout as the operation might still be running
        });

       // Enhanced embeddings type switching
       function showEmbeddingType(type) {
           document.querySelectorAll('.embedding-type-content').forEach(content => {
               content.classList.add('hidden');
           });
           
           document.querySelectorAll('.embedding-tab-button').forEach(button => {
               button.classList.remove('active', 'border-primary-500', 'text-primary-600');
               button.classList.add('border-transparent', 'text-secondary-500');
           });
           
           const targetContent = document.getElementById(type + '-embeddings-content');
           if (targetContent) {
               targetContent.classList.remove('hidden');
           }
           
           const targetButton = document.getElementById(type + '-embeddings-tab');
           if (targetButton) {
               targetButton.classList.remove('border-transparent', 'text-secondary-500');
               targetButton.classList.add('active', 'border-primary-500', 'text-primary-600');
           }
           
           if (type === 'word') {
               loadWordEmbeddingsCollections();
           }
       }

       // Auto-configure functionality
       function toggleAutoConfigureHint() {
           const checkbox = document.querySelector('input[name="auto_configure"]');
           const hint = document.getElementById('auto-configure-hint');
           
           if (checkbox && hint) {
               if (checkbox.checked) {
                   hint.classList.remove('hidden');
                   disableManualParameters();
               } else {
                   hint.classList.add('hidden');
                   enableManualParameters();
               }
           }
       }

       function disableManualParameters() {
           const manualInputs = ['dim', 'window', 'min_count', 'workers'];
           manualInputs.forEach(inputName => {
               const input = document.querySelector(`input[name="${inputName}"]`);
               if (input) {
                   input.disabled = true;
                   input.classList.add('bg-secondary-100', 'cursor-not-allowed');
               }
           });
       }

       function enableManualParameters() {
           const manualInputs = ['dim', 'window', 'min_count', 'workers'];
           manualInputs.forEach(inputName => {
               const input = document.querySelector(`input[name="${inputName}"]`);
               if (input) {
                   input.disabled = false;
                   input.classList.remove('bg-secondary-100', 'cursor-not-allowed');
               }
           });
       }

       // Enhanced form validation
        function validateForm(formElement) {
            const requiredFields = formElement.querySelectorAll('[required]');
            let isValid = true;
            let errors = [];
            
            // Special handling for searchable selects
            const searchableSelects = formElement.querySelectorAll('.searchable-select');
            searchableSelects.forEach(selectContainer => {
                const textInput = selectContainer.querySelector('input[type="text"]');
                const hiddenInput = selectContainer.querySelector('input[type="hidden"]');
                const label = selectContainer.closest('div').querySelector('label')?.textContent || 'field';
                
                if (textInput && hiddenInput) {
                    // If text input has value but hidden input is empty, copy the value
                    if (textInput.value && !hiddenInput.value) {
                        hiddenInput.value = textInput.value;
                    }
                    
                    // If both are empty and this is a required field, try to auto-populate
                    if (!hiddenInput.value) {
                        if (label.toLowerCase().includes('collection')) {
                            if (collections.length > 0) {
                                // Auto-select first collection if available
                                hiddenInput.value = collections[0];
                                textInput.value = collections[0];
                                showStatusBanner(`Auto-selected collection: ${collections[0]}`, 'info');
                            } else {
                                errors.push(`Please select a ${label.toLowerCase()}`);
                                isValid = false;
                            }
                        } else if (label.toLowerCase().includes('field')) {
                            // Auto-select 'text' for text fields
                            hiddenInput.value = 'text';
                            textInput.value = 'text';
                            showStatusBanner(`Auto-selected text field: text`, 'info');
                        }
                    }
                }
            });
            
            // Validate other required fields
            requiredFields.forEach(field => {
                if (!field.value || field.value.trim() === '') {
                    field.classList.add('border-error-500', 'bg-error-50');
                    field.classList.remove('border-secondary-200');
                    
                    const label = field.closest('div').querySelector('label')?.textContent || 'field';
                    errors.push(`${label} is required`);
                    isValid = false;
                } else {
                    field.classList.remove('border-error-500', 'bg-error-50');
                    field.classList.add('border-secondary-200');
                }
            });
            
            if (!isValid) {
                showStatusBanner(`Please fix the following errors: ${errors.join(', ')}`, 'error');
            }
            
            return isValid;
        }

       // Enhanced configuration management
       async function loadCurrentConfig() {
           try {
               showStatusBanner('Loading configuration...', 'info');
               
               const response = await fetch('/api/config/show', {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/x-www-form-urlencoded',
                   },
                   body: 'config_path='
               });
               
               const html = await response.text();
               document.getElementById('config-result').innerHTML = html;
               
               hideStatusBanner();
               showStatusBanner('Configuration loaded successfully', 'success');
               setTimeout(hideStatusBanner, 3000);
               
           } catch (error) {
               console.error('Error loading config:', error);
               document.getElementById('config-result').innerHTML = `
                   <div class="bg-error-50 border border-error-200 rounded-lg p-4">
                       <h4 class="text-sm font-medium text-error-800 mb-2">‚ùå Error Loading Configuration</h4>
                       <div class="text-sm text-error-700">Failed to load configuration: ${error.message}</div>
                   </div>
               `;
               showStatusBanner('Failed to load configuration', 'error');
           }
       }

       async function testSolrConnection() {
            try {
                showStatusBanner('Testing Solr connection...', 'info');
                
                const solrStatus = document.getElementById('solr-status');
                solrStatus.innerHTML = `
                    <div class="loading-spinner w-5 h-5 border-2 border-primary-200 border-t-primary-600 rounded-full"></div>
                    <span class="text-secondary-600">Testing Solr connection...</span>
                `;
                
                // Add timeout to the fetch request
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                try {
                    const response = await fetch('/api/ner/collections', {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    const data = await response.json();
                    
                    if (response.ok && data.collections && data.collections.length > 0) {
                        solrStatus.innerHTML = `
                            <div class="w-5 h-5 rounded-full bg-success-500 flex items-center justify-center">
                                <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <span class="text-success-700">Solr connected - ${data.collections.length} collections found</span>
                        `;
                        updateConfigStatus('success');
                        showStatusBanner(`Solr connection successful - ${data.collections.length} collections found`, 'success');
                        
                        // Update collections cache
                        collections = data.collections;
                        populateCollectionSearches();
                        
                    } else {
                        throw new Error(data.error || 'No collections found or invalid response');
                    }
                    
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    
                    let errorMessage = 'Connection failed';
                    if (fetchError.name === 'AbortError') {
                        errorMessage = 'Connection timeout (10s)';
                    } else if (fetchError.message) {
                        errorMessage = fetchError.message;
                    }
                    
                    throw new Error(errorMessage);
                }
                
            } catch (error) {
                const solrStatus = document.getElementById('solr-status');
                solrStatus.innerHTML = `
                    <div class="w-5 h-5 rounded-full bg-error-500 flex items-center justify-center">
                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <span class="text-error-700">Solr connection failed: ${error.message}</span>
                `;
                updateConfigStatus('error');
                showStatusBanner('Solr connection failed: ' + error.message, 'error');
            }
        }

       // Enhanced NER functionality
       
        async function initializeNerTab() {
            console.log('Initializing NER tab...');
            
            if (collections.length === 0) {
                console.log('Loading collections for NER tab...');
                await loadCollections();
            }
            
            // Create collection search
            createSearchableSelect(
                'ner-collection-container',
                'Search collections...',
                collections,
                'collection',
                collections[0] || null
            );
            
            // Load fields for first collection if available
            if (collections.length > 0) {
                await loadCollectionFields(collections[0], 'ner');
            }
            
            // Load other data
            await Promise.all([
                loadEntityTypes(),
                loadNerModels()
            ]);
            
            console.log('NER tab initialized successfully');
            showStatusBanner('NER tab initialized', 'success');
            setTimeout(hideStatusBanner, 2000);
        }

       async function loadNerModels() {
           try {
               const response = await fetch('/api/ner/models');
               availableModels = await response.json();
               updateNerModelDropdown();
           } catch (error) {
               console.error('Error loading NER models:', error);
               const modelSelect = document.getElementById('ner-model-name');
               if (modelSelect) {
                   modelSelect.innerHTML = '<option value="">Error loading models</option>';
               }
           }
       }

       function updateNerModelDropdown() {
           const modelType = document.getElementById('ner-model-type')?.value;
           const modelSelect = document.getElementById('ner-model-name');
           
           if (!modelSelect || !modelType) return;
           
           modelSelect.innerHTML = '';
           
           if (availableModels[modelType]) {
               availableModels[modelType].forEach(model => {
                   const option = document.createElement('option');
                   option.value = model.name;
                   option.textContent = model.display_name;
                   modelSelect.appendChild(option);
               });
           } else {
               modelSelect.innerHTML = '<option value="">No models available</option>';
           }
       }

       async function loadNerCollections() {
           try {
               const response = await fetch('/api/ner/collections');
               const data = await response.json();
               
               if (data.collections && data.collections.length > 0) {
                   collections = data.collections;
                   populateCollectionSearches();
               } else if (data.error) {
                   showStatusBanner('Solr connection error: ' + data.error, 'error');
                   // Don't show the configuration in this case
                   document.getElementById('config-result').innerHTML = `
                       <div class="bg-error-50 border border-error-200 rounded-lg p-4">
                           <h4 class="text-sm font-medium text-error-800 mb-2">‚ùå Solr Connection Error</h4>
                           <div class="text-sm text-error-700">
                               <p>Cannot connect to Solr: ${data.error}</p>
                               <p class="mt-2">Please check your Solr configuration and ensure it's running.</p>
                           </div>
                       </div>
                   `;
               }
           } catch (error) {
               console.error('Error loading collections:', error);
               showStatusBanner('Failed to load collections. Please check your connection.', 'error');
           }
       }

       async function loadEntityTypes() {
           try {
               const response = await fetch('/api/ner/entity-types');
               availableEntityTypes = await response.json();
           } catch (error) {
               console.error('Error loading entity types:', error);
               availableEntityTypes = {
                   common: ["PERSON", "ORGANIZATION", "LOCATION"],
                   transformers: ["PERSON", "ORG", "LOC", "MISC"]
               };
           }
       }

       function updateEntityTypes() {
           const modelType = document.getElementById('ner-model-type')?.value;
           const input = document.getElementById('ner-entity-types');
           
           if (!input || !modelType) return;
           
           if (availableEntityTypes[modelType]) {
               input.placeholder = availableEntityTypes[modelType].join(', ');
           } else {
               input.placeholder = "PERSON,LOCATION,ORGANIZATION";
           }
       }

       // Enhanced tokenization functionality
       async function initializeTokenizeTab() {
            console.log('Initializing Tokenize tab...');
            
            if (collections.length === 0) {
                console.log('Loading collections for Tokenize tab...');
                await loadCollections();
            }
            
            // Create collection search
            createSearchableSelect(
                'tokenize-collection-container',
                'Search collections...',
                collections,
                'collection',
                collections[0] || null
            );
            
            // Load fields for first collection if available
            if (collections.length > 0) {
                await loadCollectionFields(collections[0], 'tokenize');
            }
            
            console.log('Tokenize tab initialized successfully');
            showStatusBanner('Tokenization tab initialized', 'success');
            setTimeout(hideStatusBanner, 2000);
        }

       async function loadTokenizeCollections() {
           try {
               const response = await fetch('/api/ner/collections');
               const data = await response.json();
               
               if (data.collections && data.collections.length > 0) {
                   collections = data.collections;
                   populateCollectionSearches();
               }
           } catch (error) {
               console.error('Error loading tokenize collections:', error);
           }
       }

       // Enhanced embeddings functionality
       async function initializeEmbeddingsTab() {
            console.log('Initializing Embeddings tab...');
            
            if (collections.length === 0) {
                console.log('Loading collections for Embeddings tab...');
                await loadCollections();
            }
            
            // Create collection searches for both embedding types
            createSearchableSelect(
                'embeddings-collection-container',
                'Search collections...',
                collections,
                'collection',
                collections[0] || null
            );
            
            createSearchableSelect(
                'word-embeddings-collection-container',
                'Search collections...',
                collections,
                'collection',
                collections[0] || null
            );
            
            // Load fields for first collection if available
            if (collections.length > 0) {
                await Promise.all([
                    loadCollectionFields(collections[0], 'embeddings'),
                    loadCollectionFields(collections[0], 'word-embeddings')
                ]);
            }
            
            console.log('Embeddings tab initialized successfully');
            showStatusBanner('Embeddings tab initialized', 'success');
            setTimeout(hideStatusBanner, 2000);
        }
        function debugFormState(tabName) {
            const tab = document.getElementById(tabName + '-tab');
            if (!tab) return;
            
            const form = tab.querySelector('form');
            if (!form) return;
            
            const formData = new FormData(form);
            console.log(`=== ${tabName.toUpperCase()} Form State ===`);
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: "${value}"`);
            }
            console.log('=== End Form State ===');
        }

        // Add debugging keyboard shortcut
        document.addEventListener('keydown', function(e) {
            // Ctrl+Shift+D to debug current tab
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab-button.active');
                if (activeTab) {
                    const tabName = activeTab.id.replace('tab-', '');
                    debugFormState(tabName);
                }
            }
        });
       async function loadEmbeddingsCollections() {
           try {
               const response = await fetch('/api/ner/collections');
               const data = await response.json();
               
               if (data.collections && data.collections.length > 0) {
                   collections = data.collections;
                   populateCollectionSearches();
               }
           } catch (error) {
               console.error('Error loading embeddings collections:', error);
           }
       }
       function updateTokenizeModelHints() {
            const modelType = document.getElementById('tokenize-model-type').value;
            const modelNameInput = document.getElementById('tokenize-model-name');
            const hint = document.getElementById('tokenize-model-hint');
            
            switch (modelType) {
                case 'transformers':
                    modelNameInput.placeholder = 'bert-base-cased, roberta-base, etc.';
                    modelNameInput.required = true;
                    hint.textContent = 'HuggingFace model name or local path';
                    break;
                case 'spacy':
                    modelNameInput.placeholder = 'en_core_web_sm, zh_core_web_sm, etc.';
                    modelNameInput.required = true;
                    hint.textContent = 'spaCy model name (must be installed)';
                    break;
                case 'chinese_segmenter':
                    modelNameInput.placeholder = '';
                    modelNameInput.required = false;
                    modelNameInput.value = '';
                    hint.textContent = 'Leave empty for Chinese segmenter (no model needed)';
                    break;
            }
            }

            function updateEmbeddingsModelHints() {
            const modelType = document.getElementById('embeddings-model-type').value;
            const modelNameInput = document.getElementById('embeddings-model-name');
            const hint = document.getElementById('embeddings-model-hint');
            
            switch (modelType) {
                case 'fasttext':
                    modelNameInput.placeholder = 'fasttext-wiki, path/to/fasttext.bin';
                    hint.textContent = 'FastText model name or path to .bin file';
                    break;
                case 'word2vec':
                    modelNameInput.placeholder = 'word2vec-google-news, path/to/model.bin';
                    hint.textContent = 'Word2Vec model name or path to .bin file';
                    break;
                case 'sentence_transformers':
                    modelNameInput.placeholder = 'all-MiniLM-L6-v2, all-mpnet-base-v2';
                    hint.textContent = 'Sentence Transformers model from HuggingFace';
                    break;
            }
            }

            function updateWordEmbeddingsHints() {
            const method = document.getElementById('word-embeddings-method').value;
            const hint = document.querySelector('#word-embeddings-content .text-xs.text-secondary-500');
            
            if (method === 'word2vec') {
                hint.textContent = 'Word2Vec: Good for general text, faster training';
            } else if (method === 'fasttext') {
                hint.textContent = 'FastText: Better for rare words and morphology';
            }
        }

       async function loadWordEmbeddingsCollections() {
           try {
               const response = await fetch('/api/ner/collections');
               const data = await response.json();
               
               if (data.collections && data.collections.length > 0) {
                   collections = data.collections;
                   populateCollectionSearches();
               }
           } catch (error) {
               console.error('Error loading word embeddings collections:', error);
           }
       }

       // Enhanced file upload handling
       document.getElementById('jsonl-files')?.addEventListener('change', function(e) {
           const files = Array.from(e.target.files);
           const fileList = document.getElementById('file-list');
           
           if (files.length > 0) {
               fileList.innerHTML = `
                   <div class="mt-2 space-y-1">
                       <p class="text-sm font-medium text-secondary-700">Selected files:</p>
                       ${files.map(file => `
                           <div class="flex items-center justify-between bg-secondary-50 px-3 py-2 rounded">
                               <span class="text-sm text-secondary-600">${file.name}</span>
                               <span class="text-xs text-secondary-500">${(file.size / 1024).toFixed(1)} KB</span>
                           </div>
                       `).join('')}
                   </div>
               `;
           } else {
               fileList.innerHTML = '';
           }
       });

       // Enhanced utility functions
       async function checkHealth() {
           try {
               showStatusBanner('Checking system health...', 'info');
               
               const response = await fetch('/health');
               const data = await response.json();
               
               document.getElementById('quick-result').innerHTML = `
                   <div class="bg-success-50 border border-success-200 rounded-lg p-4">
                       <div class="flex items-center">
                           <div class="flex-shrink-0">
                               <svg class="h-5 w-5 text-success-400" fill="currentColor" viewBox="0 0 20 20">
                                   <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                               </svg>
                           </div>
                           <div class="ml-3">
                               <h3 class="text-sm font-medium text-success-800">‚úÖ System Healthy</h3>
                               <div class="mt-2 text-sm text-success-700">
                                   <p><strong>Status:</strong> ${data.status}</p>
                                   <p><strong>Version:</strong> ${data.version}</p>
                                   <p><strong>Checked:</strong> ${new Date().toLocaleString()}</p>
                               </div>
                           </div>
                       </div>
                   </div>
               `;
               
               showStatusBanner('System health check completed', 'success');
               setTimeout(hideStatusBanner, 3000);
               
           } catch (error) {
               document.getElementById('quick-result').innerHTML = `
                   <div class="bg-error-50 border border-error-200 rounded-lg p-4">
                       <div class="flex items-center">
                           <div class="flex-shrink-0">
                               <svg class="h-5 w-5 text-error-400" fill="currentColor" viewBox="0 0 20 20">
                                   <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                               </svg>
                           </div>
                           <div class="ml-3">
                               <h3 class="text-sm font-medium text-error-800">‚ùå Health Check Failed</h3>
                               <div class="mt-2 text-sm text-error-700">
                                   <p><strong>Error:</strong> ${error.message}</p>
                               </div>
                           </div>
                       </div>
                   </div>
               `;
               showStatusBanner('Health check failed: ' + error.message, 'error');
           }
       }

       function clearResults() {
            const results = ['#ner-result', '#tokenize-result', '#embeddings-result'];
            results.forEach(selector => {
                const element = document.querySelector(selector);
                if (element) {
                    element.innerHTML = '';
                }
            });
            
            // Clear any processing states
            activeProcessingTasks.forEach((taskId, type) => {
                hideProcessingState(type);
            });
            
            showStatusBanner('Results cleared', 'info');
            setTimeout(hideStatusBanner, 2000);
        }
        document.body.addEventListener('htmx:beforeRequest', function(evt) {
            const form = evt.detail.elt;
            
            // Find which processing type this is and clear its results
            let processingType = null;
            if (form.closest('#ner-tab')) processingType = 'ner';
            else if (form.closest('#tokenize-tab')) processingType = 'tokenize';
            else if (form.closest('#embeddings-tab')) {
                if (form.closest('#word-embeddings-content')) processingType = 'word-embeddings';
                else processingType = 'embeddings';
            }
            
            if (processingType) {
                clearResultsForType(processingType);
                showProcessingState(processingType);
            }
            
            if (!validateForm(form)) {
                evt.preventDefault();
                if (processingType) {
                    hideProcessingState(processingType);
                }
                return;
            }
        });
        // Clear results before starting new processing
        function clearResultsForType(type) {
            const resultSelectors = {
                'ner': '#ner-result',
                'tokenize': '#tokenize-result', 
                'embeddings': '#embeddings-result',
                'word-embeddings': '#embeddings-result'
            };
            
            const selector = resultSelectors[type];
            if (selector) {
                const element = document.querySelector(selector);
                if (element) {
                    element.innerHTML = '';
                }
            }
        }

       function clearAllResults() {
           const results = ['#config-result', '#upload-result', '#ner-result', '#tokenize-result', '#embeddings-result', '#quick-result'];
           results.forEach(selector => {
               const element = document.querySelector(selector);
               if (element) element.innerHTML = '';
           });
           showStatusBanner('All results cleared', 'info');
           setTimeout(hideStatusBanner, 2000);
       }

       // Enhanced form reset functions
       function resetNerForm() {
           if (confirm('Reset all NER form fields to default values?')) {
               const form = document.querySelector('#ner-tab form');
               if (form) {
                   form.reset();
                   
                   // Reset specific values
                   document.getElementById('ner-model-type').value = 'transformers';
                   document.getElementById('ner-field-search').value = 'text';
                   document.getElementById('ner-field-value').value = 'text';
                   
                   // Clear search fields
                   document.getElementById('ner-collection-search').value = '';
                   document.getElementById('ner-collection-value').value = '';
                   
                   loadNerModels();
                   updateEntityTypes();
                   showStatusBanner('NER form reset to defaults', 'info');
                   setTimeout(hideStatusBanner, 2000);
               }
           }
       }

       function resetTokenizeForm() {
            if (confirm('Reset all tokenization form fields to default values?')) {
                const form = document.querySelector('#tokenize-tab form');
                if (form) {
                    form.reset();
                    
                    // Reset specific values
                    document.getElementById('tokenize-model-type').value = 'transformers';
                    updateTokenizeModelHints();
                    
                    // Repopulate searchable selects
                    if (collections.length > 0) {
                        createSearchableSelect(
                            'tokenize-collection-container',
                            'Search collections...',
                            collections,
                            'collection'
                        );
                        
                        loadCollectionFields(collections[0], 'tokenize');
                    }
                    
                    showStatusBanner('Tokenization form reset to defaults', 'info');
                    setTimeout(hideStatusBanner, 2000);
                }
            }
            }

            function resetDocumentEmbeddingsForm() {
            if (confirm('Reset all document embeddings form fields to default values?')) {
                const form = document.querySelector('#document-embeddings-content form');
                if (form) {
                    form.reset();
                    
                    // Reset specific values
                    document.getElementById('embeddings-model-type').value = 'fasttext';
                    updateEmbeddingsModelHints();
                    
                    // Repopulate searchable selects
                    if (collections.length > 0) {
                        createSearchableSelect(
                            'embeddings-collection-container',
                            'Search collections...',
                            collections,
                            'collection'
                        );
                        
                        loadCollectionFields(collections[0], 'embeddings');
                    }
                    
                    showStatusBanner('Document embeddings form reset to defaults', 'info');
                    setTimeout(hideStatusBanner, 2000);
                }
            }
            }

            function resetWordEmbeddingsForm() {
            if (confirm('Reset all word embeddings form fields to default values?')) {
                const form = document.querySelector('#word-embeddings-content form');
                if (form) {
                    form.reset();
                    
                    // Reset specific values
                    document.getElementById('word-embeddings-method').value = 'word2vec';
                    updateWordEmbeddingsHints();
                    
                    // Hide auto-configure hint and re-enable inputs
                    const hint = document.getElementById('auto-configure-hint');
                    if (hint) hint.classList.add('hidden');
                    enableManualParameters();
                    
                    // Repopulate searchable selects
                    if (collections.length > 0) {
                        createSearchableSelect(
                            'word-embeddings-collection-container',
                            'Search collections...',
                            collections,
                            'collection'
                        );
                        
                        loadCollectionFields(collections[0], 'word-embeddings');
                    }
                    
                    showStatusBanner('Word embeddings form reset to defaults', 'info');
                    setTimeout(hideStatusBanner, 2000);
                }
            }
            }


       // Enhanced HTMX event handlers
       document.body.addEventListener('htmx:beforeRequest', function(evt) {
           const form = evt.detail.elt;
           if (!validateForm(form)) {
               evt.preventDefault();
               return;
           }
           
           const submitButton = form.querySelector('button[type="submit"]');
           if (submitButton) {
               submitButton.disabled = true;
               const originalText = submitButton.innerHTML;
               submitButton.innerHTML = `
                   <div class="loading-spinner w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
                   Processing...
               `;
               submitButton.dataset.originalText = originalText;
           }
       });

       document.body.addEventListener('htmx:afterRequest', function(evt) {
           const form = evt.detail.elt;
           const submitButton = form.querySelector('button[type="submit"]');
           
           if (submitButton) {
               submitButton.disabled = false;
               if (submitButton.dataset.originalText) {
                   submitButton.innerHTML = submitButton.dataset.originalText;
                   delete submitButton.dataset.originalText;
               }
           }
           
           // Hide processing states
           const formId = form.closest('.tab-content')?.id;
           if (formId) {
               const type = formId.replace('-tab', '');
               hideProcessingState(type);
           }
       });

       document.body.addEventListener('htmx:responseError', function(evt) {
           showStatusBanner('Request failed. Please check your connection and try again.', 'error');
           
           const form = evt.detail.elt;
           const formId = form.closest('.tab-content')?.id;
           if (formId) {
               const type = formId.replace('-tab', '');
               hideProcessingState(type);
           }
       });

       document.body.addEventListener('htmx:timeout', function(evt) {
           showStatusBanner('Request timed out. The operation may still be running in the background.', 'warning');
           
           const form = evt.detail.elt;
           const formId = form.closest('.tab-content')?.id;
           if (formId) {
               const type = formId.replace('-tab', '');
               hideProcessingState(type);
           }
       });

       // Enhanced keyboard shortcuts
       document.addEventListener('keydown', function(e) {
           // Ctrl/Cmd + number keys to switch tabs
           if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '5') {
               e.preventDefault();
               const tabs = ['config', 'upload', 'ner', 'tokenize', 'embeddings'];
               const tabIndex = parseInt(e.key) - 1;
               if (tabs[tabIndex]) {
                   showTab(tabs[tabIndex]);
               }
           }
           
           // Escape key to clear results
           if (e.key === 'Escape') {
               clearAllResults();
           }
           
           // Ctrl/Cmd + R to refresh current tab data
           if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
               e.preventDefault();
               const activeTab = document.querySelector('.tab-button.active');
               if (activeTab) {
                   const tabName = activeTab.id.replace('tab-', '');
                   initializeTabData(tabName);
                   showStatusBanner('Tab data refreshed', 'info');
                   setTimeout(hideStatusBanner, 2000);
               }
           }
       });

       // Entity type picker (placeholder - would need implementation)
       function showEntityTypePicker() {
           // Implementation would go here
           showStatusBanner('Entity type picker - to be implemented', 'info');
       }

       // Help function
       function showHelp() {
           const helpContent = `
               <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="this.remove()">
                   <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto" onclick="event.stopPropagation()">
                       <h3 class="text-lg font-semibold text-secondary-900 mb-4">Keyboard Shortcuts & Help</h3>
                       <div class="space-y-3 text-sm">
                           <div><kbd class="px-2 py-1 bg-secondary-100 rounded">Ctrl/Cmd + 1-5</kbd> Switch between tabs</div>
                           <div><kbd class="px-2 py-1 bg-secondary-100 rounded">Ctrl/Cmd + R</kbd> Refresh current tab data</div>
                           <div><kbd class="px-2 py-1 bg-secondary-100 rounded">Escape</kbd> Clear all results</div>
                           <div class="mt-4">
                               <h4 class="font-medium">Tips:</h4>
                               <ul class="list-disc ml-4 space-y-1 mt-2">
                                   <li>Use the search boxes to quickly find collections and fields</li>
                                   <li>Check the system status indicator in the top-right of cards</li>
                                   <li>Auto-configure in word embeddings will optimize parameters for you</li>
                                   <li>Processing tasks run in the background - you can continue using other tabs</li>
                               </ul>
                           </div>
                       </div>
                       <button onclick="this.closest('.fixed').remove()" class="mt-4 bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors">
                           Close
                       </button>
                   </div>
               </div>
           `;
           document.body.insertAdjacentHTML('beforeend', helpContent);
       }

       // Enhanced status checking with better error handling
        window.checkStatus = function(taskId) {
            // Check if we should still be monitoring this task
            const taskContainer = document.getElementById(`ner-task-${taskId}`) || 
                                document.getElementById(`tokenize-task-${taskId}`) || 
                                document.getElementById(`embeddings-task-${taskId}`) ||
                                document.getElementById(`word-embeddings-task-${taskId}`);
            
            if (!taskContainer) {
                console.log(`Task ${taskId} container not found, stopping monitoring`);
                return;
            }
            
            fetch(`/api/ner/status/${taskId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateProgressWithLogs(taskId, data);
                    
                    if (data.status === 'running' || data.status === 'starting') {
                        setTimeout(() => window.checkStatus(taskId), 2000);
                    } else if (data.status === 'completed') {
                        showStatusBanner('Processing completed successfully!', 'success');
                        setTimeout(hideStatusBanner, 5000);
                    } else if (data.status === 'failed') {
                        showStatusBanner('Processing failed. Check the logs for details.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                    
                    // Show error in the task container instead of stopping completely
                    const statusText = document.getElementById(`status-text-${taskId}`);
                    if (statusText) {
                        statusText.className = 'text-sm text-error-600 mt-1 font-medium';
                        statusText.innerHTML = `‚ùå Status check failed: ${error.message}`;
                    }
                    
                    // Retry after longer delay
                    setTimeout(() => window.checkStatus(taskId), 5000);
                });
        };

       // Keep existing progress update function but add notifications
       window.updateProgressWithLogs = function(taskId, data) {
           // [Previous implementation stays the same]
           // ... existing code ...
       };

       // Copy task ID function
       window.copyTaskId = function(taskId) {
           navigator.clipboard.writeText(taskId).then(() => {
               showStatusBanner('Task ID copied to clipboard!', 'success');
               setTimeout(hideStatusBanner, 2000);
           }).catch(() => {
               showStatusBanner('Failed to copy task ID', 'error');
           });
       };
   </script>
</body>
</html>